<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAFM System API Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .section-header {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .section-content {
            padding: 20px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .test-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .test-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-info {
            background: #17a2b8;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .input-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .result-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success {
            background: #27ae60;
        }
        
        .status-error {
            background: #e74c3c;
        }
        
        .status-warning {
            background: #f39c12;
        }
        
        .status-info {
            background: #3498db;
        }
        
        .user-info {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .api-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .api-status-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .api-status-card h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
            .main-content {
                padding: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ CAFM System API Test Dashboard</h1>
            <p>Comprehensive testing interface for all CAFM system endpoints and functionality</p>
        </div>

        <div class="main-content">
            <!-- Authentication Section -->
            <div class="section">
                <div class="section-header">
                    üîê Authentication & User Management
                </div>
                <div class="section-content">
                    <div class="test-grid">
                        <div class="test-card">
                            <h4>User Login</h4>
                            <div class="input-group">
                                <label>Email:</label>
                                <input type="email" id="loginEmail" value="admin@cafm.com" placeholder="Enter email">
                            </div>
                            <div class="input-group">
                                <label>Password:</label>
                                <input type="password" id="loginPassword" value="Admin123!" placeholder="Enter password">
                            </div>
                            <button class="btn btn-success" onclick="testLogin()">Login</button>
                            <button class="btn btn-warning" onclick="testLogout()">Logout</button>
                        </div>

                        <div class="test-card">
                            <h4>Quick Login Tests</h4>
                            <button class="btn btn-info" onclick="quickLogin('admin@cafm.com', 'Admin123!')">Login as Admin</button>
                            <button class="btn btn-info" onclick="quickLogin('plumber@cafm.com', 'Plumber123!')">Login as Plumber</button>
                            <button class="btn btn-info" onclick="quickLogin('cleaner@cafm.com', 'Cleaner123!')">Login as Cleaner</button>
                            <button class="btn btn-info" onclick="quickLogin('user@cafm.com', 'User123!')">Login as EndUser</button>
                        </div>

                        <div class="test-card">
                            <h4>Authentication Status</h4>
                            <div id="authStatus" class="user-info">Not logged in</div>
                            <button class="btn" onclick="validateToken()">Validate Token</button>
                            <button class="btn" onclick="getRoles()">Get Available Roles</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tickets Management Section -->
            <div class="section">
                <div class="section-header">
                    üé´ Tickets Management & Testing
                </div>
                <div class="section-content">
                    <div class="test-grid">
                        <div class="test-card">
                            <h4>Get Tickets</h4>
                            <button class="btn btn-success" onclick="getTickets()">Get All Tickets</button>
                            <button class="btn btn-info" onclick="getTickets('?status=1')">Get Open Tickets</button>
                            <button class="btn btn-info" onclick="getTickets('?status=2')">Get In Progress</button>
                            <button class="btn btn-warning" onclick="getTickets('?priority=4')">Get Critical Tickets</button>
                        </div>

                        <div class="test-card">
                            <h4>Ticket Statistics</h4>
                            <button class="btn btn-success" onclick="getTicketStats()">Get Ticket Stats</button>
                            <button class="btn btn-info" onclick="getDepartmentStats()">Get Department Stats</button>
                            <button class="btn btn-info" onclick="getLiveMetrics()">Get Live Metrics</button>
                            <button class="btn btn-warning" onclick="getActivityHistory()">Get Activity History</button>
                        </div>

                        <div class="test-card">
                            <h4>Create Test Ticket</h4>
                            <div class="input-group">
                                <label>Title:</label>
                                <input type="text" id="ticketTitle" value="Test ticket from API test page" placeholder="Enter ticket title">
                            </div>
                            <div class="input-group">
                                <label>Description:</label>
                                <textarea id="ticketDescription" placeholder="Enter ticket description">This is a test ticket created from the API test page to verify ticket creation functionality.</textarea>
                            </div>
                            <div class="input-group">
                                <label>Category:</label>
                                <select id="ticketCategory">
                                    <option value="1">General</option>
                                    <option value="2">Plumbing</option>
                                    <option value="3">Electrical</option>
                                    <option value="4">HVAC</option>
                                    <option value="5">Cleaning</option>
                                    <option value="8">Maintenance</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Priority:</label>
                                <select id="ticketPriority">
                                    <option value="1">Low</option>
                                    <option value="2" selected>Medium</option>
                                    <option value="3">High</option>
                                    <option value="4">Critical</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Type:</label>
                                <select id="ticketType">
                                    <option value="2" selected>Service</option>
                                    <option value="1">Material</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Location:</label>
                                <input type="text" id="ticketLocation" value="Test Location - API Test Page" placeholder="Enter location">
                            </div>
                            <button class="btn btn-success" onclick="createTestTicket()">Create Test Ticket</button>
                        </div>

                        <div class="test-card">
                            <h4>Ticket Operations</h4>
                            <div class="input-group">
                                <label>Ticket ID:</label>
                                <input type="number" id="ticketId" placeholder="Enter ticket ID">
                            </div>
                            <button class="btn btn-info" onclick="getTicketById()">Get Ticket by ID</button>
                            <button class="btn btn-warning" onclick="updateTicketStatus()">Update Status to InProgress</button>
                            <button class="btn btn-success" onclick="getNextTicketId()">Get Next Ticket ID</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Section -->
            <div class="section">
                <div class="section-header">
                    üë• User Management & Role Testing
                </div>
                <div class="section-content">
                    <div class="test-grid">
                        <div class="test-card">
                            <h4>Get Users</h4>
                            <button class="btn btn-success" onclick="getUsers()">Get All Users</button>
                            <button class="btn btn-info" onclick="getUsersByRole('Plumber')">Get Plumbers</button>
                            <button class="btn btn-info" onclick="getUsersByRole('Electrician')">Get Electricians</button>
                            <button class="btn btn-info" onclick="getUsersByRole('Cleaner')">Get Cleaners</button>
                            <button class="btn btn-warning" onclick="getUsersByRole('Admin')">Get Admins</button>
                        </div>

                        <div class="test-card">
                            <h4>User Registration Test</h4>
                            <div class="input-group">
                                <label>Email:</label>
                                <input type="email" id="regEmail" value="testuser@cafm.com" placeholder="Enter email">
                            </div>
                            <div class="input-group">
                                <label>Password:</label>
                                <input type="password" id="regPassword" value="TestUser123!" placeholder="Enter password">
                            </div>
                            <div class="input-group">
                                <label>First Name:</label>
                                <input type="text" id="regFirstName" value="Test" placeholder="Enter first name">
                            </div>
                            <div class="input-group">
                                <label>Last Name:</label>
                                <input type="text" id="regLastName" value="User" placeholder="Enter last name">
                            </div>
                            <div class="input-group">
                                <label>Department:</label>
                                <input type="text" id="regDepartment" value="Testing" placeholder="Enter department">
                            </div>
                            <button class="btn btn-success" onclick="testUserRegistration()">Register Test User</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Health & Backend Tests -->
            <div class="section">
                <div class="section-header">
                    üîß System Health & Backend Tests
                </div>
                <div class="section-content">
                    <div class="quick-actions">
                        <button class="btn btn-success" onclick="testBackendConnection()">Test Backend Connection</button>
                        <button class="btn btn-info" onclick="testAllEndpoints()">Test All Endpoints</button>
                        <button class="btn btn-warning" onclick="testRoleBasedAccess()">Test Role-Based Access</button>
                        <button class="btn btn-danger" onclick="clearResults()">Clear Results</button>
                    </div>

                    <div class="api-status" id="apiStatus">
                        <div class="api-status-card">
                            <h5>Backend Status</h5>
                            <div id="backendStatus">
                                <span class="status-indicator status-warning"></span>Not tested
                            </div>
                        </div>
                        <div class="api-status-card">
                            <h5>Authentication</h5>
                            <div id="authApiStatus">
                                <span class="status-indicator status-warning"></span>Not tested
                            </div>
                        </div>
                        <div class="api-status-card">
                            <h5>Tickets API</h5>
                            <div id="ticketsApiStatus">
                                <span class="status-indicator status-warning"></span>Not tested
                            </div>
                        </div>
                        <div class="api-status-card">
                            <h5>Users API</h5>
                            <div id="usersApiStatus">
                                <span class="status-indicator status-warning"></span>Not tested
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Frontend Tests -->
            <div class="section">
                <div class="section-header">
                    üåê Frontend Integration Tests
                </div>
                <div class="section-content">
                    <div class="test-grid">
                        <div class="test-card">
                            <h4>Frontend Application Tests</h4>
                            <button class="btn btn-info" onclick="testFrontendConnection()">Test Frontend Connection</button>
                            <button class="btn btn-success" onclick="openFrontendDashboard()">Open Frontend Dashboard</button>
                            <button class="btn btn-warning" onclick="openFrontendTickets()">Open Frontend Tickets</button>
                            <button class="btn btn-info" onclick="openFrontendLogin()">Open Frontend Login</button>
                        </div>

                        <div class="test-card">
                            <h4>Integration Status</h4>
                            <div id="frontendStatus" class="user-info">
                                <span class="status-indicator status-warning"></span>Frontend not tested
                            </div>
                            <button class="btn" onclick="testFullIntegration()">Test Full Integration</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Display -->
            <div class="section">
                <div class="section-header">
                    üìä Test Results & Logs
                </div>
                <div class="section-content">
                    <div id="results" class="result-area">
                        Welcome to CAFM System API Test Dashboard! Click any button above to start testing the system. Results will appear here with detailed information about each API call. üîç Available Tests: - Authentication (Login/Logout/Token validation) - Tickets Management
                        (CRUD operations) - User Management (Get users by role) - System Health (Backend connectivity) - Frontend Integration (React app testing) üìù Quick Start: 1. Click "Test Backend Connection" to verify the API is running 2. Use "Login
                        as Admin" to authenticate 3. Click "Get All Tickets" to test ticket retrieval 4. Try "Create Test Ticket" to test ticket creation 5. Use "Test All Endpoints" for comprehensive testing Ready to test! üöÄ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:5000/api';
        const FRONTEND_BASE = 'http://localhost:5173';

        let currentToken = localStorage.getItem('cafm_test_token') || '';
        let currentUser = null;

        // Utility Functions
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            results.textContent += `\n[${timestamp}] ${icon} ${message}`;
            results.scrollTop = results.scrollHeight;
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            if (element) {
                const statusClass = status === 'success' ? 'status-success' :
                    status === 'error' ? 'status-error' :
                    status === 'warning' ? 'status-warning' : 'status-info';
                element.innerHTML = `<span class="status-indicator ${statusClass}"></span>${message}`;
            }
        }

        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            if (currentUser) {
                authStatus.innerHTML = `
                    <strong>Logged in as:</strong> ${currentUser.email}<br>
                    <strong>Name:</strong> ${currentUser.firstName} ${currentUser.lastName}<br>
                    <strong>Roles:</strong> ${currentUser.roles.join(', ')}<br>
                    <strong>User ID:</strong> ${currentUser.userId}
                `;
            } else {
                authStatus.innerHTML = 'Not logged in';
            }
        }

        async function makeApiCall(endpoint, method = 'GET', body = null, useAuth = true) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                };

                if (useAuth && currentToken) {
                    headers['Authorization'] = `Bearer ${currentToken}`;
                }

                const config = {
                    method,
                    headers,
                };

                if (body) {
                    config.body = JSON.stringify(body);
                }

                log(`Making ${method} request to ${endpoint}...`);
                const response = await fetch(`${API_BASE}${endpoint}`, config);

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = {
                        message: responseText
                    };
                }

                if (response.ok) {
                    log(`‚úÖ ${method} ${endpoint} - Success (${response.status})`, 'success');
                    return {
                        success: true,
                        data,
                        status: response.status
                    };
                } else {
                    log(`‚ùå ${method} ${endpoint} - Error (${response.status}): ${data.message || 'Unknown error'}`, 'error');
                    return {
                        success: false,
                        data,
                        status: response.status
                    };
                }
            } catch (error) {
                log(`‚ùå ${method} ${endpoint} - Network Error: ${error.message}`, 'error');
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Authentication Functions
        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                log('Please enter both email and password', 'warning');
                return;
            }

            const result = await makeApiCall('/auth/login', 'POST', {
                email,
                password
            }, false);

            if (result.success && result.data.success) {
                currentToken = result.data.token;
                currentUser = {
                    userId: result.data.user.id,
                    email: result.data.user.email,
                    firstName: result.data.user.firstName,
                    lastName: result.data.user.lastName,
                    roles: result.data.user.roles
                };

                localStorage.setItem('cafm_test_token', currentToken);
                updateAuthStatus();
                updateStatus('authApiStatus', 'success', 'Login successful');
                log(`Login successful for ${email} with roles: ${currentUser.roles.join(', ')}`, 'success');
            } else {
                updateStatus('authApiStatus', 'error', 'Login failed');
                log(`Login failed: ${result.data?.message || 'Unknown error'}`, 'error');
            }
        }

        async function quickLogin(email, password) {
            document.getElementById('loginEmail').value = email;
            document.getElementById('loginPassword').value = password;
            await testLogin();
        }

        function testLogout() {
            currentToken = '';
            currentUser = null;
            localStorage.removeItem('cafm_test_token');
            updateAuthStatus();
            updateStatus('authApiStatus', 'warning', 'Logged out');
            log('Logged out successfully', 'success');
        }

        async function validateToken() {
            if (!currentToken) {
                log('No token to validate. Please login first.', 'warning');
                return;
            }

            const result = await makeApiCall('/auth/validate-token');
            if (result.success) {
                log(`Token validation successful. User ID: ${result.data.userId}`, 'success');
            } else {
                log('Token validation failed', 'error');
                testLogout();
            }
        }

        async function getRoles() {
            const result = await makeApiCall('/auth/roles', 'GET', null, false);
            if (result.success) {
                log(`Available roles: ${result.data.join(', ')}`, 'success');
            }
        }

        // Ticket Functions
        async function getTickets(queryParams = '') {
            const result = await makeApiCall(`/tickets${queryParams}`);
            if (result.success) {
                const tickets = result.data.tickets || [];
                log(`Retrieved ${tickets.length} tickets (Total: ${result.data.totalCount || tickets.length})`, 'success');
                if (tickets.length > 0) {
                    log(`Sample tickets: ${tickets.slice(0, 3).map(t => `ID:${t.id} "${t.title}"`).join(', ')}`, 'info');
                }
                updateStatus('ticketsApiStatus', 'success', `${tickets.length} tickets retrieved`);
            } else {
                updateStatus('ticketsApiStatus', 'error', 'Failed to get tickets');
            }
        }

        async function getTicketStats() {
            const result = await makeApiCall('/tickets/stats');
            if (result.success) {
                const stats = result.data;
                log(`Ticket Stats - Total: ${stats.totalTickets}, Open: ${stats.openTickets}, InProgress: ${stats.inProgressTickets}, Completed: ${stats.completedTickets}`, 'success');
                updateStatus('ticketsApiStatus', 'success', `Stats: ${stats.totalTickets} total tickets`);
            }
        }

        async function getDepartmentStats() {
            const result = await makeApiCall('/tickets/department-stats');
            if (result.success) {
                log(`Department stats retrieved: ${result.data.length} departments`, 'success');
            }
        }

        async function getLiveMetrics() {
            const result = await makeApiCall('/tickets/live-metrics');
            if (result.success) {
                const metrics = result.data;
                log(`Live Metrics - Active Users: ${metrics.activeUsers}, Tickets Today: ${metrics.ticketsCreatedToday}, Completed Today: ${metrics.ticketsCompletedToday}`, 'success');
            }
        }

        async function getActivityHistory() {
            const result = await makeApiCall('/tickets/activity-history');
            if (result.success) {
                log(`Activity history retrieved: ${result.data.length} entries`, 'success');
            }
        }

        async function createTestTicket() {
            if (!currentUser) {
                log('Please login first to create a ticket', 'warning');
                return;
            }

            const ticketData = {
                title: document.getElementById('ticketTitle').value,
                description: document.getElementById('ticketDescription').value,
                category: parseInt(document.getElementById('ticketCategory').value),
                priority: parseInt(document.getElementById('ticketPriority').value),
                type: parseInt(document.getElementById('ticketType').value),
                location: document.getElementById('ticketLocation').value,
                requestedByUserId: currentUser.userId
            };

            const result = await makeApiCall('/tickets', 'POST', ticketData);
            if (result.success) {
                log(`Test ticket created successfully! ID: ${result.data.id}`, 'success');
                document.getElementById('ticketId').value = result.data.id;
            }
        }

        async function getTicketById() {
            const ticketId = document.getElementById('ticketId').value;
            if (!ticketId) {
                log('Please enter a ticket ID', 'warning');
                return;
            }

            const result = await makeApiCall(`/tickets/${ticketId}`);
            if (result.success) {
                const ticket = result.data;
                log(`Ticket ${ticketId}: "${ticket.title}" - Status: ${ticket.statusText}, Priority: ${ticket.priorityText}`, 'success');
            }
        }

        async function updateTicketStatus() {
            const ticketId = document.getElementById('ticketId').value;
            if (!ticketId) {
                log('Please enter a ticket ID', 'warning');
                return;
            }

            const result = await makeApiCall(`/tickets/${ticketId}`, 'PUT', { status: 2 }); // InProgress
            if (result.success) {
                log(`Ticket ${ticketId} status updated to InProgress`, 'success');
            }
        }

        async function getNextTicketId() {
            const result = await makeApiCall('/tickets/next-id');
            if (result.success) {
                log(`Next ticket ID will be: ${result.data.nextId}`, 'success');
                document.getElementById('ticketId').value = result.data.nextId;
            }
        }

        // User Management Functions
        async function getUsers() {
            const result = await makeApiCall('/users');
            if (result.success) {
                log(`Retrieved ${result.data.length} users`, 'success');
                updateStatus('usersApiStatus', 'success', `${result.data.length} users found`);
            } else {
                updateStatus('usersApiStatus', 'error', 'Failed to get users');
            }
        }

        async function getUsersByRole(role) {
            const result = await makeApiCall(`/users/role/${role}`);
            if (result.success) {
                log(`Retrieved ${result.data.length} users with role: ${role}`, 'success');
                if (result.data.length > 0) {
                    log(`${role}s: ${result.data.map(u => u.fullName).join(', ')}`, 'info');
                }
            }
        }

        async function testUserRegistration() {
            const userData = {
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                department: document.getElementById('regDepartment').value
            };

            const result = await makeApiCall('/auth/register', 'POST', userData, false);
            if (result.success) {
                log(`User registration successful for ${userData.email}`, 'success');
            }
        }

        // System Health Functions
        async function testBackendConnection() {
            log('Testing backend connection...', 'info');
            const result = await makeApiCall('/auth/roles', 'GET', null, false);

            if (result.success) {
                updateStatus('backendStatus', 'success', 'Backend online');
                log('Backend connection successful!', 'success');
                return true;
            } else {
                updateStatus('backendStatus', 'error', 'Backend offline');
                log('Backend connection failed!', 'error');
                return false;
            }
        }

        async function testAllEndpoints() {
            log('=== Starting comprehensive endpoint testing ===', 'info');

            // Test backend connection
            const backendOnline = await testBackendConnection();
            if (!backendOnline) {
                log('Backend is offline. Cannot continue testing.', 'error');
                return;
            }

            // Test authentication
            await getRoles();

            // Test with admin login
            await quickLogin('admin@cafm.com', 'Admin123!');
            if (currentUser) {
                await getTickets();
                await getTicketStats();
                await getUsers();
                log('Admin endpoint testing completed', 'success');
            }

            // Test with service provider
            await quickLogin('plumber@cafm.com', 'Plumber123!');
            if (currentUser) {
                await getTickets();
                await getTicketStats();
                log('Service provider endpoint testing completed', 'success');
            }

            log('=== Comprehensive testing completed ===', 'success');
        }

        async function testRoleBasedAccess() {
            log('=== Testing role-based access control ===', 'info');

            const testUsers = [
                { email: 'admin@cafm.com', password: 'Admin123!', role: 'Admin' },
                { email: 'plumber@cafm.com', password: 'Plumber123!', role: 'Plumber' },
                { email: 'cleaner@cafm.com', password: 'Cleaner123!', role: 'Cleaner' }
            ];

            for (const user of testUsers) {
                log(`Testing access for ${user.role}...`, 'info');
                await quickLogin(user.email, user.password);

                if (currentUser) {
                    const ticketsResult = await makeApiCall('/tickets');
                    const statsResult = await makeApiCall('/tickets/stats');

                    if (ticketsResult.success && statsResult.success) {
                        const ticketCount = ticketsResult.data.tickets?.length || 0;
                        const totalTickets = statsResult.data.totalTickets || 0;
                        log(`${user.role} can see ${ticketCount} tickets (${totalTickets} total)`, 'success');
                    }
                }

                await new Promise(resolve => setTimeout(resolve, 1000)); // Small delay
            }

            log('=== Role-based access testing completed ===', 'success');
        }

        // Frontend Integration Functions
        async function testFrontendConnection() {
            try {
                log('Testing frontend connection...', 'info');
                const response = await fetch(FRONTEND_BASE);

                if (response.ok) {
                    updateStatus('frontendStatus', 'success', 'Frontend online');
                    log('Frontend connection successful!', 'success');
                    return true;
                } else {
                    updateStatus('frontendStatus', 'error', 'Frontend offline');
                    log('Frontend connection failed!', 'error');
                    return false;
                }
            } catch (error) {
                updateStatus('frontendStatus', 'error', 'Frontend offline');
                log(`Frontend connection error: ${error.message}`, 'error');
                return false;
            }
        }

        function openFrontendDashboard() {
            window.open(`${FRONTEND_BASE}/dashboard`, '_blank');
            log('Opened frontend dashboard in new tab', 'info');
        }

        function openFrontendTickets() {
            window.open(`${FRONTEND_BASE}/tickets`, '_blank');
            log('Opened frontend tickets page in new tab', 'info');
        }

        function openFrontendLogin() {
            window.open(`${FRONTEND_BASE}/login`, '_blank');
            log('Opened frontend login page in new tab', 'info');
        }

        async function testFullIntegration() {
            log('=== Starting full integration test ===', 'info');

            // Test backend
            const backendOnline = await testBackendConnection();

            // Test frontend
            const frontendOnline = await testFrontendConnection();

            if (backendOnline && frontendOnline) {
                log('Full integration test: PASSED - Both backend and frontend are online', 'success');

                // Test authentication flow
                await quickLogin('admin@cafm.com', 'Admin123!');
                if (currentUser) {
                    log('Authentication integration: PASSED', 'success');

                    // Test data flow
                    const result = await getTickets();
                    if (result !== false) {
                        log('Data integration: PASSED', 'success');
                    }
                }
            } else {
                log('Full integration test: FAILED - One or more services are offline', 'error');
            }

            log('=== Full integration test completed ===', 'success');
        }

        // Utility Functions
        function clearResults() {
            document.getElementById('results').textContent = 'Results cleared. Ready for new tests! üöÄ';
            log('Test results cleared', 'info');
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            log('CAFM System API Test Dashboard loaded successfully!', 'success');
            log('Backend URL: ' + API_BASE, 'info');
            log('Frontend URL: ' + FRONTEND_BASE, 'info');

            // Restore token if exists
            if (currentToken) {
                log('Found existing token in localStorage', 'info');
                validateToken();
            }

            updateAuthStatus();
            log('Ready to start testing! Click any button above to begin.', 'info');
        });
    </script>
</body>

</html>